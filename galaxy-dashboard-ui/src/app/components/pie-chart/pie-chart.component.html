<!-- Ultra-Premium Pie Chart Widget - Notion/Linear Style -->
<div class="premium-pie-chart-widget group h-full relative overflow-hidden">
  
  <!-- Glass morphism background with premium gradients -->
  <div class="absolute inset-0 bg-gradient-to-br from-white/95 via-slate-50/90 to-blue-50/95 backdrop-blur-2xl"></div>
  <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_left,rgba(59,130,246,0.05),transparent_50%)]"></div>
  <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_bottom_right,rgba(139,92,246,0.04),transparent_50%)]"></div>
  <div class="absolute inset-0 border border-gray-200/60 rounded-3xl"></div>
  <div class="absolute inset-0 border border-white/60 rounded-3xl"></div>
  
  <!-- Main content container -->
  <div class="relative z-10 h-full flex flex-col p-4">
    
    <!-- Header Section with Premium Design -->
    <div class="flex items-center justify-between mb-4 flex-shrink-0">
      <div class="flex items-center space-x-4">
        <!-- Premium title section -->
        <div class="flex items-center space-x-3">
          <div class="w-1 h-8 bg-gradient-to-b from-blue-500 via-violet-500 to-pink-500 rounded-full shadow-lg"></div>
          <div>
            <h3 class="text-xl font-bold bg-gradient-to-r from-gray-900 via-gray-800 to-gray-700 bg-clip-text text-transparent leading-tight">{{title}}</h3>
            <div class="flex items-center space-x-2 mt-1">
              <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse shadow-sm"></div>
              <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Live insights</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Premium controls section -->
      <div class="flex items-center space-x-3">
        <!-- Time range selector -->
        <div class="relative" *ngIf="!isRefreshing">
          <select 
            [(ngModel)]="selectedTimeFrame" 
            (ngModelChange)="onTimeFrameChange($event)"
            class="no-drag appearance-none bg-white/80 border border-gray-200/80 rounded-2xl px-5 py-2.5 pr-10 text-sm font-semibold text-gray-700 hover:bg-white hover:border-blue-300/50 focus:outline-none focus:ring-2 focus:ring-blue-400/30 focus:border-blue-400/60 transition-all duration-300 cursor-pointer shadow-sm hover:shadow-lg">
            <option value="7d">Last 7 days</option>
            <option value="1w">Last week</option>
            <option value="1m">Last month</option>
            <option value="3m">Last 3 months</option>
            <option value="6m">Last 6 months</option>
            <option value="1y">Last year</option>
            <option value="all">All time</option>
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
        </div>
        
        <!-- Widget actions -->
        <app-widget-header
          [title]="''"
          [isLoading]="isRefreshing"
          [dashboardWidgetId]="data?.dashboardWidgetId"
          [widgetData]="getExpandedData()"
          (onRefresh)="handleRefresh()"
          (onExpand)="handleExpand($event)"
          (onClose)="handleClose($event)"
          class="premium-widget-actions">
        </app-widget-header>
      </div>
    </div>

    <!-- Premium Statistics Cards -->
    <!-- <div *ngIf="!isRefreshing && chartSummary" class="mb-4 flex-shrink-0">
      <div class="grid grid-cols-3 gap-3">
        
        <div class="group relative p-4 bg-gradient-to-br from-blue-50/80 via-white/90 to-indigo-50/70 rounded-2xl border border-blue-100/60 hover:border-blue-200/80 transition-all duration-300 hover:shadow-lg hover:shadow-blue-100/50 hover:-translate-y-1">
          <div class="flex items-center justify-between mb-3">
            <div class="p-2 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg">
              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path>
              </svg>
            </div>
            <span class="text-xs font-bold text-blue-600 uppercase tracking-wider">Total</span>
          </div>
          <div class="text-2xl font-black text-gray-900 mb-1">{{chartSummary.total | number:'1.0-0'}}</div>
          <div class="text-xs font-medium text-gray-600">{{chartSummary.totalLabel}}</div>
        </div>
        
        <div class="group relative p-4 bg-gradient-to-br from-violet-50/80 via-white/90 to-purple-50/70 rounded-2xl border border-violet-100/60 hover:border-violet-200/80 transition-all duration-300 hover:shadow-lg hover:shadow-violet-100/50 hover:-translate-y-1">
          <div class="flex items-center justify-between mb-3">
            <div class="p-2 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl shadow-lg">
              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <span class="text-xs font-bold text-violet-600 uppercase tracking-wider">Largest</span>
          </div>
          <div class="text-2xl font-black text-gray-900 mb-1">{{chartSummary.largest | number:'1.1-1'}}%</div>
          <div class="text-xs font-medium text-gray-600 truncate">{{chartSummary.largestLabel}}</div>
        </div>
        
        <div class="group relative p-4 bg-gradient-to-br from-emerald-50/80 via-white/90 to-teal-50/70 rounded-2xl border border-emerald-100/60 hover:border-emerald-200/80 transition-all duration-300 hover:shadow-lg hover:shadow-emerald-100/50 hover:-translate-y-1">
          <div class="flex items-center justify-between mb-3">
            <div class="p-2 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl shadow-lg">
              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path>
              </svg>
            </div>
            <span class="text-xs font-bold text-emerald-600 uppercase tracking-wider">Items</span>
          </div>
          <div class="text-2xl font-black text-gray-900 mb-1">{{chartSummary.segments}}</div>
          <div class="text-xs font-medium text-gray-600">segments</div>
        </div>
      </div>
    </div> -->

    <div *ngIf="isRefreshing" class="flex-1 flex items-center justify-center min-h-[300px]">
      <div class="text-center">
        <div class="relative inline-flex items-center justify-center w-20 h-20 mb-6">
          <div class="absolute inset-0 bg-gradient-to-br from-blue-500 via-violet-500 to-pink-500 rounded-3xl animate-pulse shadow-2xl"></div>
          <div class="relative w-10 h-10 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
        </div>
        <p class="text-base font-semibold text-gray-700 mb-2">Analyzing distribution</p>
        <p class="text-sm text-gray-500">Processing insights...</p>
      </div>
    </div>

    <!-- Main Content: Chart left, Legend right -->
    <div *ngIf="!isRefreshing" class="flex-1 flex flex-col lg:flex-row gap-8 min-h-0">
      
      <!-- Chart Container -->
      <div class="flex-1 flex items-center justify-center min-h-[320px] relative">
        <!-- Modern chart backdrop with animated gradient -->
        <div class="absolute inset-8 bg-gradient-to-br from-purple-50/40 via-pink-50/30 to-blue-50/40 rounded-full opacity-80 animate-pulse-slow"></div>
        <div class="absolute inset-10 bg-gradient-to-br from-white/60 to-gray-50/40 rounded-full backdrop-blur-sm"></div>
        
        <div class="relative w-full max-w-md aspect-square">
          <!-- Chart canvas with perfect aspect ratio -->
          <canvas baseChart
                  [data]="chartData"
                  [options]="chartOptions"
                  [type]="'pie'"
                  class="premium-pie-canvas relative z-10 w-full h-full rounded-full">
          </canvas>
        </div>
      </div>

      <!-- Simple Legend -->
      <div *ngIf="shouldShowLegend && chartData.labels" class="w-full lg:w-64 flex-shrink-0" style="display: flex;align-items: center;justify-content: center;">
        <div class="space-y-2">
          <div 
            *ngFor="let label of chartData.labels; let i = index" 
            class="flex items-center justify-between p-2 bg-white/60 hover:bg-white/80 rounded-lg border border-gray-100/40 transition-all duration-200 cursor-pointer"
            (mouseenter)="highlightSegment(i)"
            (mouseleave)="clearHighlight()">
            
            <div class="flex items-center space-x-3 flex-1 min-w-0">
              <div 
                class="w-3 h-3 rounded-full flex-shrink-0" 
                [style.background-color]="getSegmentColor(i)">
              </div>
              <span class="text-sm font-medium text-gray-700 truncate">{{label}}</span>
            </div>
            
            <span class="text-sm font-bold text-gray-900 ml-2">{{getSegmentPercentage(i)}}%</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Premium hover glow effect -->
  <div class="absolute inset-0 rounded-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none bg-gradient-to-br from-blue-100/10 via-transparent to-violet-100/10"></div>
</div>